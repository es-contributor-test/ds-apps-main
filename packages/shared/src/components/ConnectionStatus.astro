---
/**
 * ConnectionStatus component - shows live connection status for external services
 * Used on: Game page, Contribute page
 * 
 * Displays green/red dots indicating whether PostHog and Supabase are reachable.
 * Checks are performed client-side on mount.
 */

interface Props {
  class?: string
  showLabels?: boolean
}

const { class: className = '', showLabels = true } = Astro.props

// Pass env vars to client
const posthogHost = import.meta.env.PUBLIC_POSTHOG_HOST
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY
---

<div 
  class:list={['connection-status flex items-center gap-3 text-xs', className]}
  data-posthog-host={posthogHost}
  data-supabase-url={supabaseUrl}
  data-supabase-key={supabaseKey}
>
  <div class='flex items-center gap-1.5'>
    <span class='status-dot h-2 w-2 rounded-full bg-gray-400' data-service='posthog'></span>
    {showLabels && <span class='text-muted-foreground'>PostHog</span>}
  </div>
  <div class='flex items-center gap-1.5'>
    <span class='status-dot h-2 w-2 rounded-full bg-gray-400' data-service='supabase'></span>
    {showLabels && <span class='text-muted-foreground'>Supabase</span>}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.connection-status').forEach(async (container) => {
      const posthogHost = container.getAttribute('data-posthog-host')
      const supabaseUrl = container.getAttribute('data-supabase-url')
      const supabaseKey = container.getAttribute('data-supabase-key')
      
      const posthogDot = container.querySelector('[data-service="posthog"]') as HTMLElement
      const supabaseDot = container.querySelector('[data-service="supabase"]') as HTMLElement
      
      // Check PostHog - use batch endpoint which accepts empty array
      if (posthogHost && posthogDot) {
        try {
          const response = await fetch(`${posthogHost}/batch/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ batch: [] }),
            signal: AbortSignal.timeout(3000)
          })
          // PostHog returns 200 even for empty batch if reachable
          posthogDot.classList.remove('bg-gray-400')
          posthogDot.classList.add(response.ok || response.status === 400 ? 'bg-emerald-500' : 'bg-red-500')
        } catch {
          posthogDot.classList.remove('bg-gray-400')
          posthogDot.classList.add('bg-red-500')
        }
      }
      
      // Check Supabase
      if (supabaseUrl && supabaseKey && supabaseDot) {
        try {
          const response = await fetch(`${supabaseUrl}/rest/v1/`, {
            headers: {
              'apikey': supabaseKey,
              'Authorization': `Bearer ${supabaseKey}`
            },
            signal: AbortSignal.timeout(3000)
          })
          supabaseDot.classList.remove('bg-gray-400')
          supabaseDot.classList.add(response.ok ? 'bg-emerald-500' : 'bg-red-500')
        } catch {
          supabaseDot.classList.remove('bg-gray-400')
          supabaseDot.classList.add('bg-red-500')
        }
      }
    })
  })
</script>
