---
import type { Project } from '../lib/projects'
import { STATUS_CONFIG } from '../lib/projects'

interface Props {
  project: Project
  variant?: 'full' | 'compact'
}

const { project, variant = 'full' } = Astro.props
const statusConfig = STATUS_CONFIG[project.status]
const hasStats = !!project.stats

// Pass Supabase config to client script
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY
---

{variant === 'full' ? (
  <!-- Full variant: Build Log style (large card, "Try It →" button) -->
  <div class='border border-border bg-primary-foreground p-6 shadow-lg shadow-black/5 transition hover:-translate-y-0.5 hover:border-foreground/30 hover:shadow-xl'>
    <div class='flex flex-wrap items-start justify-between gap-4'>
      <div class='space-y-3'>
        <div class='flex items-center gap-3'>
          <h3 class='text-xl font-semibold text-foreground'>{project.name}</h3>
          <span class={`inline-flex items-center gap-1 px-2.5 py-1 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
            <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
            {statusConfig.label}
          </span>
        </div>
        <p class='max-w-xl text-sm text-muted-foreground'>
          {project.description}
        </p>
        <div class='flex flex-wrap gap-2'>
          {project.tags.map((tag) => (
            <span class='bg-muted px-2.5 py-1 text-sm font-medium text-muted-foreground'>
              {tag.name}
            </span>
          ))}
        </div>
        
        {/* Live Stats Row */}
        {hasStats && (
          <div 
            class='project-stats flex flex-wrap gap-4 pt-2'
            data-project-id={project.id}
            data-metrics={JSON.stringify(project.stats!.metrics)}
          >
            {project.stats!.metrics.map((metric) => (
              <div class='flex flex-col'>
                <span 
                  class='stat-value text-lg font-bold text-foreground tabular-nums'
                  data-key={metric.key}
                >
                  —
                </span>
                <span class='text-xs text-muted-foreground'>{metric.label}</span>
              </div>
            ))}
          </div>
        )}
      </div>
      <div class='flex flex-col gap-2 sm:flex-row'>
        {project.hubUrl && (
          <a
            href={project.hubUrl}
            class='inline-flex items-center gap-2 border border-sky-500 bg-sky-50 px-5 py-2.5 text-sm font-semibold text-sky-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-sky-100 dark:bg-sky-500/10 dark:text-sky-400 dark:hover:bg-sky-500/20'
          >
            Project Docs
          </a>
        )}
        <a
          href={project.url}
          class='inline-flex items-center gap-2 bg-foreground px-5 py-2.5 text-sm font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
        >
          Try It →
        </a>
      </div>
    </div>
  </div>
) : (
  <!-- Compact variant: Home page style (smaller, nested card) -->
  <div class='border border-border border-orange-600 bg-background p-4 transition hover:border-foreground/30 hover:shadow-sm'>
    <div class='flex items-start justify-between gap-3'>
      <div class='space-y-1.5'>
        <div class='flex items-center gap-2'>
          <span class='text-base font-semibold text-foreground'>{project.name}</span>
          <span class={`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
            <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
            {statusConfig.label}
          </span>
        </div>
        <p class='text-sm text-muted-foreground'>{project.shortDescription}</p>
        
        {/* Compact Stats Row */}
        {hasStats && (
          <div 
            class='project-stats flex flex-wrap gap-3 pt-1'
            data-project-id={project.id}
            data-metrics={JSON.stringify(project.stats!.metrics)}
          >
            {project.stats!.metrics.map((metric) => (
              <span class='text-xs text-muted-foreground'>
                <span 
                  class='stat-value font-semibold text-foreground tabular-nums'
                  data-key={metric.key}
                >
                  —
                </span>
                {' '}{metric.label}
              </span>
            ))}
          </div>
        )}
        
        <div class='flex flex-wrap gap-1.5 pt-0.5'>
          {project.tags.map((tag) => (
            <span class='bg-muted px-2 py-0.5 text-xs font-medium text-muted-foreground'>
              {tag.name}
            </span>
          ))}
        </div>
      </div>
      <a
        href={project.url}
        class='inline-flex shrink-0 items-center gap-1 bg-foreground px-3 py-1.5 text-xs font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
      >
        Try It →
      </a>
    </div>
  </div>
)}

{/* Client-side hydration script for stats */}
{hasStats && (
  <script
    is:inline
    define:vars={{
      SUPABASE_URL: supabaseUrl,
      SUPABASE_ANON_KEY: supabaseKey
    }}
  >
    // Hydrate project stats on page load - calls Supabase directly
    document.addEventListener('DOMContentLoaded', () => {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        console.debug('Supabase not configured, skipping stats')
        return
      }
      
      document.querySelectorAll('.project-stats').forEach(async (container) => {
        const projectId = container.getAttribute('data-project-id')
        const metrics = JSON.parse(container.getAttribute('data-metrics') || '[]')
        
        if (!projectId) return
        
        try {
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/v_project_stats?project_id=eq.${projectId}&select=*`,
            {
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              }
            }
          )
          
          if (!response.ok) throw new Error('Failed to fetch')
          
          const rows = await response.json()
          const data = rows[0]
          if (!data) return
          
          // Update each stat value
          metrics.forEach((metric) => {
            const el = container.querySelector(`[data-key="${metric.key}"]`)
            if (!el || data[metric.key] === undefined) return
            
            let value = data[metric.key]
            
            // Format the value
            if (metric.format === 'percent') {
              value = `${value}%`
            } else if (typeof value === 'number') {
              value = value.toLocaleString()
            }
            
            el.textContent = value
          })
        } catch (error) {
          // Silently fail - stats will show "—"
          console.debug('Could not load project stats:', error)
        }
      })
    })
  </script>
)}
