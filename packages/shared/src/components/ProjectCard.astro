---
import type { Project } from '../lib/projects'
import { STATUS_CONFIG } from '../lib/projects'

interface Props {
  project: Project
  variant?: 'full' | 'compact'
  showStats?: boolean
}

const { project, variant = 'full', showStats = true } = Astro.props
const statusConfig = STATUS_CONFIG[project.status]
const isActive = project.status === 'live' || project.status === 'in-progress'

// Pass Supabase config to client script
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY
---

{variant === 'full' ? (
  <!-- Full variant: Build Log style (large card, "Try It →" button) -->
  <div class='border border-border bg-primary-foreground p-6 shadow-lg shadow-black/5 transition hover:-translate-y-0.5 hover:border-foreground/30 hover:shadow-xl'>
    <div class='flex flex-wrap items-start justify-between gap-4'>
      <div class='space-y-3'>
        <div class='flex items-center gap-3'>
          <h3 class='text-xl font-semibold text-foreground'>{project.name}</h3>
          <span class={`inline-flex items-center gap-1 px-2.5 py-1 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
            <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
            {statusConfig.label}
          </span>
        </div>
        <p class='max-w-xl text-sm text-muted-foreground'>
          {project.description}
        </p>
        <div class='flex flex-wrap gap-2'>
          {project.tags.map((tag) => (
            <span class='bg-muted px-2.5 py-1 text-sm font-medium text-muted-foreground'>
              {tag.name}
            </span>
          ))}
        </div>
        
        {/* Standard Engagement Stats */}
        {showStats && isActive && (
          <div 
            class='project-engagement-stats pt-2 text-sm text-muted-foreground'
            data-project-id={project.id}
            data-supabase-url={supabaseUrl}
            data-supabase-key={supabaseKey}
          >
            <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='total_views'>—</span> Total Views
            <span class='mx-2'>|</span>
            <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='views_30d'>—</span> P30D Views
            <span class='mx-2'>|</span>
            Rank <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='rank'>—</span>
          </div>
        )}
      </div>
      <div class='flex flex-col gap-2 sm:flex-row'>
        {project.hubUrl && (
          <a
            href={project.hubUrl}
            class='inline-flex items-center gap-2 border border-sky-500 bg-sky-50 px-5 py-2.5 text-sm font-semibold text-sky-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-sky-100 dark:bg-sky-500/10 dark:text-sky-400 dark:hover:bg-sky-500/20'
          >
            Project Docs
          </a>
        )}
        <a
          href={project.url}
          class='inline-flex items-center gap-2 bg-foreground px-5 py-2.5 text-sm font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
        >
          Try It →
        </a>
      </div>
    </div>
  </div>
) : (
  <!-- Compact variant: Home page style (smaller, nested card) -->
  <div class='border border-border border-orange-600 bg-background p-4 transition hover:border-foreground/30 hover:shadow-sm'>
    <div class='flex items-start justify-between gap-3'>
      <div class='space-y-1.5'>
        <div class='flex items-center gap-2'>
          <span class='text-base font-semibold text-foreground'>{project.name}</span>
          <span class={`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
            <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
            {statusConfig.label}
          </span>
        </div>
        <p class='text-sm text-muted-foreground'>{project.shortDescription}</p>
        
        {/* Compact Stats Row */}
        {showStats && isActive && (
          <div 
            class='project-engagement-stats pt-1 text-xs text-muted-foreground'
            data-project-id={project.id}
            data-supabase-url={supabaseUrl}
            data-supabase-key={supabaseKey}
          >
            <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='total_views'>—</span> Total Views
            <span class='mx-1.5'>|</span>
            <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='views_30d'>—</span> P30D Views
            <span class='mx-1.5'>|</span>
            Rank <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='rank'>—</span>
          </div>
        )}
        
        <div class='flex flex-wrap gap-1.5 pt-0.5'>
          {project.tags.map((tag) => (
            <span class='bg-muted px-2 py-0.5 text-xs font-medium text-muted-foreground'>
              {tag.name}
            </span>
          ))}
        </div>
      </div>
      <a
        href={project.url}
        class='inline-flex shrink-0 items-center gap-1 bg-foreground px-3 py-1.5 text-xs font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
      >
        Try It →
      </a>
    </div>
  </div>
)}

{/* Client-side hydration script for standard engagement stats */}
<script is:inline>
  // Hydrate engagement stats on page load
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.project-engagement-stats').forEach(async (container) => {
      const projectId = container.getAttribute('data-project-id')
      const supabaseUrl = container.getAttribute('data-supabase-url')
      const supabaseKey = container.getAttribute('data-supabase-key')
      
      if (!projectId || !supabaseUrl || !supabaseKey) return
      
      try {
        const response = await fetch(
          `${supabaseUrl}/rest/v1/rpc/project_engagement_stats`,
          {
            method: 'POST',
            headers: {
              'apikey': supabaseKey,
              'Authorization': `Bearer ${supabaseKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ p_project_id: projectId })
          }
        )
        
        if (!response.ok) return
        
        const rows = await response.json()
        const data = rows[0]
        if (!data) return
        
        const totalEl = container.querySelector('[data-stat="total_views"]')
        const views30dEl = container.querySelector('[data-stat="views_30d"]')
        const rankEl = container.querySelector('[data-stat="rank"]')
        
        if (totalEl && data.total_views !== undefined) {
          totalEl.textContent = data.total_views.toLocaleString()
        }
        if (views30dEl && data.views_30d !== undefined) {
          views30dEl.textContent = data.views_30d.toLocaleString()
        }
        if (rankEl && data.rank !== undefined && data.total_projects !== undefined) {
          rankEl.textContent = `#${data.rank} of ${data.total_projects}`
        }
      } catch (error) {
        console.debug('Could not load engagement stats:', error)
      }
    })
  })
</script>
