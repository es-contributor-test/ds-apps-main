---
import AppLayout from '../../../shared/src/layouts/AppLayout.astro'
---

<AppLayout projectId="ab-simulator" showDescription={false}>
	<!-- Custom Description (more detailed than projects.yaml) -->
	<div class='-mt-4 mb-4'>
		<p class='text-base text-muted-foreground'>
			Interactive memory game puzzle demonstrating A/B testing with PostHog experiments and
			real-time analytics.
			<br />I built this from scratch using a full analytics stack with Astro front‚Äëend ‚Üí Supabase
			PostgREST (SQL views/RPCs) ‚Üí PostHog events ‚Üí Supabase Webhooks ‚Üí Plotly charts on Astro. My
			goal is to show not just what experimentation means from a statistical POV, but also from a
			tech implementation and user experience POV.
		</p>
	</div>

	<!-- Challenge Info -->
	<div id='challenge-section' class='rounded-lg border bg-card p-4'>
		<h3 class='mb-3 font-semibold'>Your Challenge</h3>
		<div class='grid grid-cols-2 gap-3 md:grid-cols-4'>
			<div class='text-sm'>
				<div class='text-xs text-muted-foreground'>Variant</div>
				<div id='user-variant' class='font-mono font-bold'>Loading...</div>
			</div>
			<div class='text-sm'>
				<div class='text-xs text-muted-foreground'>Your Random Username</div>
					<div id='user-username' class='truncate font-mono'>Loading...</div>
				</div>
				<div class='text-sm'>
					<div class='text-xs text-muted-foreground'>Difficulty</div>
					<div id='difficulty-display' class='font-mono'>Loading...</div>
				</div>
				<div class='text-sm'>
					<div class='text-xs text-muted-foreground'>No. of Pineapples to Find</div>
					<div id='target-word-count' class='font-mono font-bold'>0</div>
				</div>
			</div>
		</div>

		<!-- Puzzle Section -->
		<div id='puzzle-section' class='space-y-4 rounded-2xl border bg-card/95 p-4'>
			<div class='flex flex-col gap-3'>
				<h3 class='font-semibold'>MEMORY GAME: Find the Pineapples üçç.</h3>
				<p class='text-sm text-muted-foreground'>
					Click Start to reveal the board, memorize all pineapples in 10 seconds, then find them
					before the timer expires.
				</p>
			</div>

			<!-- Three-column layout: Grid (1/3) + Controls/Progress (1/3) + Stats (1/3) -->
			<div class='grid gap-6 md:grid-cols-2 xl:grid-cols-3'>
				<!-- LEFT: Letter Grid with sticky guidance pill -->
				<div class='space-y-4'>
					<div class='space-y-2'>
						<div id='memorize-pill' class='memorize-pill' data-state='idle'>
							<div
								class='flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground'
							>
								<span class='text-base'>üçç</span>
								<span id='memorize-pill-text'>Click Start to reveal the board.</span>
							</div>
							<div class='flex items-center gap-2 text-sm'>
								<span class='text-muted-foreground'
									>You get <strong>7 seconds</strong> to memorize.</span
								>
								<span id='memorize-countdown' class='memorize-countdown' aria-live='polite'>7s</span
								>
							</div>
						</div>
						<div
							id='letter-grid'
							class='grid max-w-[320px] grid-cols-5 gap-4 rounded-2xl border-2 border-transparent p-2 transition-all duration-300'
						>
						</div>
					</div>
				</div>

				<!-- CENTER: Controls + Pineapple Progress -->
				<div class='flex flex-col gap-4'>
					<div class='space-y-3 rounded-2xl border border-border/60 bg-muted/60 p-4 shadow-sm'>
						<div id='controls' class='flex flex-row gap-2'>
							<button
								id='start-button'
								class='flex-1 rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90'
								>Start</button
							>
							<button
								id='reset-button'
								class='hidden flex-1 rounded-lg bg-foreground px-3 py-2 text-sm font-medium text-background transition-colors hover:bg-foreground/90'
								>Stop</button
							>
							<button
								class='try-again-button hidden flex-1 rounded-lg bg-foreground px-3 py-2 text-sm font-medium text-background transition-colors hover:bg-foreground/90'
								>Try Again</button
							>
						</div>
						<div class='grid grid-cols-3 items-center rounded-lg bg-card p-3'>
							<div class='text-xs text-muted-foreground'>Time</div>
							<div id='timer' class='col-span-2 font-mono text-2xl font-bold'>00:60:00</div>
						</div>
					</div>
					<div class='pineapple-progress' aria-live='polite'>
						<div
							class='flex items-center justify-between text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground'
						>
							<span>Pineapple Tracker</span>
							<span class='text-[11px]'>
								<span id='pineapple-progress-found'>0</span>/<span id='pineapple-target'>0</span>
							</span>
						</div>
						<div class='pineapple-progress-track' id='pineapple-progress-track'>
							<div class='pineapple-progress-fill' id='pineapple-progress-fill'></div>
							<div class='pineapple-progress-slots' id='pineapple-progress-slots'></div>
						</div>
						<div id='pineapple-stats' class='pineapple-stats' aria-live='polite'>
							<div class='pineapple-stats-time'>
								<span class='label'>Time</span>
								<span id='pineapple-result-time' class='value'>00:00:00</span>
							</div>
							<div class='pineapple-stats-divider'></div>
							<div class='pineapple-stats-guesses'>
								<span class='label'>Guesses</span>
								<span id='pineapple-result-guesses' class='value'>0</span>
							</div>
							<div id='pineapple-personal-best' class='pineapple-stats-pill hidden'>
								<span>‚ú® Personal Best</span>
							</div>
						</div>
					</div>
				</div>

				<!-- RIGHT: Leaderboard (1/3) -->
				<div
					id='leaderboard-display'
					class='rounded-2xl border border-border/60 bg-muted/70 p-3 shadow-sm'
				>
					<div
						class='flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.2em] text-muted-foreground'
					>
						<span class='text-base'>üèÜ</span>
						<span>Top Players</span>
					</div>
					<div id='leaderboard-list' class='mt-3 text-xs'></div>
				</div>
			</div>
		</div>

		<!-- Dashboard -->
		<div id='dashboard-section' class='space-y-6 rounded-lg border bg-card p-4'>
			<div class='flex items-center justify-between'>
				<div>
					<h3 class='font-semibold'>üìä Analytics Dashboard</h3>
					<p class='text-xs text-muted-foreground'>Real-time A/B test results</p>
				</div>
				<div class='flex items-center gap-3'>
					<button
						onclick='window.refreshDashboard()'
						class='rounded border border-gray-300 px-2 py-1 text-xs transition-colors hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-800'
						title='Refresh dashboard data'
					>
						üîÑ Refresh
					</button>
					<div id='update-indicator' class='text-xs text-muted-foreground'>
						<span id='last-updated'>Loading...</span>
					</div>
				</div>
			</div>

			<!-- Comparison Card (High Priority) -->
			<div class='rounded-xl border bg-card p-6'>
				<div class='grid grid-cols-3 gap-6'>
					<!-- Variant A -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div
								class='flex h-6 w-6 items-center justify-center rounded bg-[#f9e9cc] text-xs font-bold text-black'
							>
								A
							</div>
							<div class='text-sm font-semibold'>Control (4 pineapples)</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Total Completions</div>
							<div id='variant-a-count' class='text-2xl font-bold'>--</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Avg Completion Time</div>
							<div id='variant-a-time' class='font-mono text-2xl font-bold'>--</div>
						</div>
					</div>

					<!-- Variant B -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div
								class='flex h-6 w-6 items-center justify-center rounded bg-[#f5a656] text-xs font-bold text-black'
							>
								B
							</div>
							<div class='text-sm font-semibold'>Treatment (5 pineapples)</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Total Completions</div>
							<div id='variant-b-count' class='text-2xl font-bold'>--</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Avg Completion Time</div>
							<div id='variant-b-time' class='font-mono text-2xl font-bold'>--</div>
						</div>
					</div>

					<!-- Comparison -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div class='text-xl'>‚öñÔ∏è</div>
							<div class='text-sm font-semibold'>Comparison</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Time Difference</div>
							<div id='comparison-diff' class='font-mono text-2xl font-bold text-muted-foreground'>
								--%
							</div>
						</div>
						<div id='comparison-status-box' class='rounded-lg bg-muted p-3'>
							<div id='comparison-status' class='text-sm font-medium'>--</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Funnel Chart (Moved up) -->
			<div class='rounded-lg border bg-card p-4'>
				<div id='funnel-chart'></div>
			</div>

			<!-- Charts Grid: Avg Time + Distribution -->
			<div class='grid grid-cols-1 gap-6 lg:grid-cols-2'>
				<!-- Avg Time Chart -->
				<div class='rounded-lg border bg-card p-4'>
					<div id='avg-time-chart'></div>
				</div>

				<!-- Distribution Chart (Histogram) -->
				<div class='rounded-lg border bg-card p-4'>
					<div id='distribution-chart'></div>
				</div>
			</div>

			<!-- Recent Completions Table -->
			<div class='rounded-lg border bg-card p-4'>
				<h4 class='mb-4 text-sm font-semibold'>Recent Completions</h4>
				<div id='completions-table'></div>
			</div>
		</div>

		<script src='https://cdn.plot.ly/plotly-2.27.0.min.js' is:inline></script>
		<script src='/ab-simulator/js/utils.js' is:inline></script>
		<script src='/ab-simulator/js/puzzle-config.js' is:inline></script>
		<!-- Inject Supabase config for PostgREST access (uses public env vars) -->
		<script
			is:inline
			define:vars={{
				SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL,
				SUPABASE_ANON_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY
			}}
		>
			window.__SUPABASE_URL__ = SUPABASE_URL
			window.__SUPABASE_ANON_KEY__ = SUPABASE_ANON_KEY
		</script>
		<script src='/ab-simulator/js/ab-sim/supabase-api.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/personal-best.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/leaderboard-ui.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/analytics.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/core.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/dashboard.js' is:inline></script>
</AppLayout>

<script>
	import { uniqueNamesGenerator, adjectives, animals } from 'unique-names-generator'

	// Export to global window for use by ab-simulator.js
	;(window as any).generateRandomUsername = function () {
		return uniqueNamesGenerator({
			dictionaries: [adjectives, animals],
			separator: ' ',
			style: 'capital',
			length: 2
		})
	}
</script>

<!-- consolidated into /js/ab-sim/core.js -->
