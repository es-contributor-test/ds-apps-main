---
import AppLayout from '../../../shared/src/layouts/AppLayout.astro'
---

<AppLayout projectId="ab-simulator" showDescription={false}>
	<!-- Hero Value Prop - 3 Column + Your Assignment -->
	<div class='-mt-4 mb-6 overflow-hidden rounded-2xl border-2 border-slate-200 bg-gradient-to-br from-slate-50 via-white to-amber-50/50 shadow-lg dark:border-slate-700 dark:from-slate-900 dark:via-slate-900 dark:to-amber-950/20'>
		<div class='grid divide-y md:grid-cols-3 md:divide-x md:divide-y-0 divide-slate-200 dark:divide-slate-700'>
			<!-- Col 1: You're in the experiment -->
			<div class='flex flex-col items-center gap-3 p-6 text-center'>
				<div class='flex h-14 w-14 items-center justify-center rounded-2xl bg-amber-100 text-3xl dark:bg-amber-500/20'>üé≤</div>
				<div class='text-xl font-bold text-slate-900 dark:text-white'>You're in the Experiment</div>
				<p class='text-base text-slate-600 dark:text-slate-400'>
					Randomly assigned to <strong class='text-amber-600 dark:text-amber-400'>Variant A</strong> or <strong class='text-orange-600 dark:text-orange-400'>Variant B</strong> with different difficulty levels.
				</p>
			</div>
			<!-- Col 2: Play the game -->
			<div class='flex flex-col items-center gap-3 p-6 text-center'>
				<div class='flex h-14 w-14 items-center justify-center rounded-2xl bg-emerald-100 text-3xl dark:bg-emerald-500/20'>üéÆ</div>
				<div class='text-xl font-bold text-slate-900 dark:text-white'>Play the Memory Game</div>
				<p class='text-base text-slate-600 dark:text-slate-400'>
					Memorize pineapple locations, then find them all. Your completion time is tracked.
				</p>
			</div>
			<!-- Col 3: Watch results -->
			<div class='flex flex-col items-center gap-3 p-6 text-center'>
				<div class='flex h-14 w-14 items-center justify-center rounded-2xl bg-sky-100 text-3xl dark:bg-sky-500/20'>üìä</div>
				<div class='text-xl font-bold text-slate-900 dark:text-white'>See Real-Time Results</div>
				<p class='text-base text-slate-600 dark:text-slate-400'>
					Live analytics dashboard below. Deep-dive in <a href='/projects/ab-simulator' class='whitespace-nowrap font-semibold text-sky-600 underline decoration-sky-300 underline-offset-2 hover:text-sky-700 dark:text-sky-400 dark:decoration-sky-600 dark:hover:text-sky-300'>Project&nbsp;Docs&nbsp;‚Üí</a>
				</p>
			</div>
		</div>
		<!-- Your Assignment Bar -->
		<div id='challenge-section' class='flex flex-wrap items-center justify-center gap-x-8 gap-y-3 border-t border-slate-200 bg-slate-100/80 px-6 py-4 dark:border-slate-700 dark:bg-slate-800/50'>
			<div class='flex items-center gap-2'>
				<span class='text-sm font-medium text-slate-500 dark:text-slate-400'>Variant:</span>
				<span id='user-variant' class='rounded-lg bg-white px-3 py-1 font-mono text-sm font-bold shadow-sm dark:bg-slate-900'>Loading...</span>
			</div>
			<div class='flex items-center gap-2'>
				<span class='text-sm font-medium text-slate-500 dark:text-slate-400'>Username:</span>
				<span id='user-username' class='max-w-[180px] truncate rounded-lg bg-white px-3 py-1 font-mono text-sm shadow-sm dark:bg-slate-900'>Loading...</span>
			</div>
			<div class='flex items-center gap-2'>
				<span class='text-sm font-medium text-slate-500 dark:text-slate-400'>Find:</span>
				<span class='flex items-center gap-1 rounded-lg bg-white px-3 py-1 font-mono text-sm font-bold shadow-sm dark:bg-slate-900'>
					<span id='target-word-count'>0</span>
					<span>üçç</span>
				</span>
			</div>
		</div>
	</div>

		<!-- Puzzle Section -->
		<div id='puzzle-section' class='space-y-4 rounded-2xl border bg-card/95 p-4'>
			<h3 class='text-lg font-semibold'>Memorize the pineapple locations, then find them all üçç</h3>

			<!-- Three-column layout: Grid (1/3) + Controls/Progress (1/3) + Stats (1/3) -->
			<div class='grid gap-6 md:grid-cols-2 xl:grid-cols-3'>
				<!-- LEFT: Letter Grid with countdown pill -->
				<div class='space-y-3'>
					<div id='memorize-pill' class='memorize-pill' data-state='idle'>
						<div class='flex items-center justify-between'>
							<span id='memorize-pill-text' class='text-sm font-medium text-slate-600 dark:text-slate-300'>Memorize Time</span>
							<div id='memorize-countdown' class='memorize-countdown' aria-live='polite'>7s</div>
						</div>
					</div>
					<div
						id='letter-grid'
						class='grid grid-cols-5 gap-2 rounded-2xl border-2 border-transparent p-1 transition-all duration-300'
					>
					</div>
				</div>

				<!-- CENTER: Controls + Pineapple Progress -->
				<div class='flex flex-col gap-4'>
					<div class='space-y-3 rounded-2xl border border-border/60 bg-muted/60 p-4 shadow-sm'>
						<div id='controls' class='flex flex-row gap-2'>
							<button
								id='start-button'
								class='flex-1 rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90'
								>Start</button
							>
							<button
								id='reset-button'
								class='hidden flex-1 rounded-lg bg-foreground px-3 py-2 text-sm font-medium text-background transition-colors hover:bg-foreground/90'
								>Stop</button
							>
							<button
								class='try-again-button hidden flex-1 rounded-lg bg-foreground px-3 py-2 text-sm font-medium text-background transition-colors hover:bg-foreground/90'
								>Try Again</button
							>
						</div>
						<div class='flex items-center justify-between rounded-xl bg-card px-4 py-3'>
							<div class='text-sm font-medium text-muted-foreground'>Time</div>
							<div id='timer' class='font-mono text-3xl font-bold tabular-nums tracking-tight'>00:60:00</div>
						</div>
					</div>
					<div class='pineapple-progress' aria-live='polite'>
						<div class='flex items-center justify-between'>
							<span class='text-xs font-bold uppercase tracking-widest text-slate-600 dark:text-slate-300'>Pineapple Tracker</span>
							<span class='font-mono text-sm font-semibold tabular-nums text-slate-700 dark:text-slate-200'>
								<span id='pineapple-progress-found'>0</span>/<span id='pineapple-target'>0</span>
							</span>
						</div>
						<div class='pineapple-progress-track' id='pineapple-progress-track'>
							<div class='pineapple-progress-fill' id='pineapple-progress-fill'></div>
							<div class='pineapple-progress-slots' id='pineapple-progress-slots'></div>
						</div>
						<div id='pineapple-stats' class='pineapple-stats' aria-live='polite'>
							<div class='pineapple-stats-time'>
								<span class='label'>Time</span>
								<span id='pineapple-result-time' class='value'>00:00:00</span>
							</div>
							<div class='pineapple-stats-divider'></div>
							<div class='pineapple-stats-guesses'>
								<span class='label'>Guesses</span>
								<span id='pineapple-result-guesses' class='value'>0</span>
							</div>
							<div id='pineapple-personal-best' class='pineapple-stats-pill hidden'>
								<span>‚ú® Personal Best</span>
							</div>
						</div>
					</div>
				</div>

				<!-- RIGHT: Leaderboard (1/3) -->
				<div
					id='leaderboard-display'
					class='rounded-2xl border border-border/60 bg-muted/70 p-4 shadow-sm'
				>
					<div class='flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-slate-600 dark:text-slate-300'>
						<span class='text-lg'>üèÜ</span>
						<span>Top Players</span>
					</div>
					<div id='leaderboard-list' class='mt-3'></div>
				</div>
			</div>
		</div>

		<!-- Dashboard -->
		<div id='dashboard-section' class='space-y-6 rounded-lg border bg-card p-4'>
			<div class='flex items-center justify-between'>
				<div>
					<h3 class='mb-3 text-lg font-semibold'>üìä Analytics Dashboard</h3>
					<p class='text-xs text-muted-foreground'>Real-time A/B test results</p>
				</div>
				<div class='flex items-center gap-3'>
					<button
						onclick='window.refreshDashboard()'
						class='rounded border border-gray-300 px-2 py-1 text-xs transition-colors hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-800'
						title='Refresh dashboard data'
					>
						üîÑ Refresh
					</button>
					<div id='update-indicator' class='text-xs text-muted-foreground'>
						<span id='last-updated'>Loading...</span>
					</div>
				</div>
			</div>

			<!-- Comparison Card (High Priority) -->
			<div class='rounded-xl border bg-card p-6'>
				<div class='grid grid-cols-3 gap-6'>
					<!-- Variant A -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div
								class='flex h-6 w-6 items-center justify-center rounded bg-[#f9e9cc] text-xs font-bold text-black'
							>
								A
							</div>
							<div class='text-sm font-semibold'>Control (4 pineapples)</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Total Completions</div>
							<div id='variant-a-count' class='text-2xl font-bold'>--</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Avg Completion Time</div>
							<div id='variant-a-time' class='font-mono text-2xl font-bold'>--</div>
						</div>
					</div>

					<!-- Variant B -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div
								class='flex h-6 w-6 items-center justify-center rounded bg-[#f5a656] text-xs font-bold text-black'
							>
								B
							</div>
							<div class='text-sm font-semibold'>Treatment (5 pineapples)</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Total Completions</div>
							<div id='variant-b-count' class='text-2xl font-bold'>--</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Avg Completion Time</div>
							<div id='variant-b-time' class='font-mono text-2xl font-bold'>--</div>
						</div>
					</div>

					<!-- Comparison -->
					<div class='space-y-3'>
						<div class='flex items-center gap-2'>
							<div class='text-xl'>‚öñÔ∏è</div>
							<div class='text-sm font-semibold'>Comparison</div>
						</div>
						<div>
							<div class='text-xs text-muted-foreground'>Time Difference</div>
							<div id='comparison-diff' class='font-mono text-2xl font-bold text-muted-foreground'>
								--%
							</div>
						</div>
						<div id='comparison-status-box' class='rounded-lg bg-muted p-3'>
							<div id='comparison-status' class='text-sm font-medium'>--</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Funnel Chart (Moved up) -->
			<div class='rounded-lg border bg-card p-4'>
				<div id='funnel-chart'></div>
			</div>

			<!-- Charts Grid: Avg Time + Distribution -->
			<div class='grid grid-cols-1 gap-6 lg:grid-cols-2'>
				<!-- Avg Time Chart -->
				<div class='rounded-lg border bg-card p-4'>
					<div id='avg-time-chart'></div>
				</div>

				<!-- Distribution Chart (Histogram) -->
				<div class='rounded-lg border bg-card p-4'>
					<div id='distribution-chart'></div>
				</div>
			</div>

			<!-- Recent Completions Table -->
			<div class='rounded-lg border bg-card p-4'>
				<h3 class='mb-4 text-lg font-semibold'>Recent Completions</h3>
				<div id='completions-table'></div>
			</div>

			<!-- Global Completions Map -->
			<div class='rounded-lg border bg-card p-4'>
				<div class='mb-4 flex items-center justify-between'>
					<div class='flex items-center gap-3'>
						<h3 class='text-lg font-semibold'>üåç Global Completions Map</h3>
						<span class='text-xs text-muted-foreground'>Scroll to zoom ‚Ä¢ Click markers for details</span>
					</div>
					<div class='flex items-center gap-4 text-sm'>
						<span class='flex items-center gap-1.5'>
							<span class='inline-block h-3 w-3 rounded-full bg-[#F7CA45] ring-1 ring-amber-500'></span>
							<span class='text-muted-foreground'>Variant A</span>
						</span>
						<span class='flex items-center gap-1.5'>
							<span class='inline-block h-3 w-3 rounded-full bg-[#4572F7] ring-1 ring-blue-600'></span>
							<span class='text-muted-foreground'>Variant B</span>
						</span>
					</div>
				</div>
				<div id='geo-map' class='h-[450px] w-full cursor-pointer rounded-lg'></div>
			</div>
		</div>

		<!-- Leaflet for geo map -->
		<link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css' />
		<script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js' is:inline></script>

		<script src='https://cdn.plot.ly/plotly-2.27.0.min.js' is:inline></script>
		<script src='/ab-simulator/js/utils.js' is:inline></script>
		<script src='/ab-simulator/js/puzzle-config.js' is:inline></script>
		<!-- Inject Supabase config for PostgREST access (uses public env vars) -->
		<script
			is:inline
			define:vars={{
				SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL,
				SUPABASE_ANON_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY
			}}
		>
			window.__SUPABASE_URL__ = SUPABASE_URL
			window.__SUPABASE_ANON_KEY__ = SUPABASE_ANON_KEY
		</script>
		<script src='/ab-simulator/js/ab-sim/supabase-api.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/personal-best.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/leaderboard-ui.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/analytics.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/core.js' is:inline></script>
		<script src='/ab-simulator/js/ab-sim/dashboard.js' is:inline></script>
</AppLayout>

<script>
	import { uniqueNamesGenerator, adjectives, animals } from 'unique-names-generator'

	// Export to global window for use by ab-simulator.js
	;(window as any).generateRandomUsername = function () {
		return uniqueNamesGenerator({
			dictionaries: [adjectives, animals],
			separator: ' ',
			style: 'capital',
			length: 2
		})
	}
</script>

<!-- consolidated into /js/ab-sim/core.js -->
