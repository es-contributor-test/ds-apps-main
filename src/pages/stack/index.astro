---
import BaseLayout from '@/layouts/BaseLayout.astro'
import Timeline from '../../../packages/shared/src/components/Timeline.astro'
import { parseProjectsYaml, getProjectsByStatus } from '../../../packages/shared/src/lib/projects'
import projectsYaml from '../../../packages/shared/src/data/projects.yaml?raw'

const allProjects = parseProjectsYaml(projectsYaml)
const inProgressProjects = getProjectsByStatus(allProjects, 'in-progress')
const upcomingProjects = getProjectsByStatus(allProjects, 'coming-soon')
---

<BaseLayout meta={{ title: 'Stack' }}>
  <article class="prose prose-slate dark:prose-invert max-w-none">
    <!-- Back link -->
    <a href="/" class="no-underline text-sm text-muted-foreground hover:text-foreground transition inline-flex items-center gap-1 mb-6">
      â† Back to Home
    </a>

    <h1 class="text-2xl font-bold mb-2">How It's Built</h1>
    
    <p class="text-muted-foreground">
      This site is a monorepo built with Astro, deployed on Cloudflare Pages, with analytics powered by PostHog and Supabase. Here's how the pieces fit together.
    </p>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Architecture Overview -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸ—ï¸ Architecture</h2>
    
    <p class="text-muted-foreground mb-4">Data flows from user action to live dashboard:</p>

    <!-- Simple vertical flow diagram -->
    <div class="flex flex-col items-center gap-0 text-sm">
      <!-- Cloudflare -->
      <div class="w-full max-w-md border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">CLOUDFLARE</div>
        <div class="flex flex-wrap gap-2">
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Pages (eeshans.com)</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Worker (/ingest/*)</span>
        </div>
      </div>
      
      <div class="text-slate-400 text-lg">â†“</div>
      
      <!-- PostHog -->
      <div class="w-full max-w-md border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">POSTHOG</div>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Events</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Webhook</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Supabase destination</span>
        </div>
      </div>
      
      <div class="text-slate-400 text-lg">â†“</div>
      
      <!-- Supabase -->
      <div class="w-full max-w-md border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">SUPABASE</div>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Edge Function</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">PostgreSQL</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Views</span>
        </div>
      </div>
      
      <div class="text-slate-400 text-lg">â†“</div>
      
      <!-- Frontend -->
      <div class="w-full max-w-md border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">FRONTEND</div>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">PostgREST API</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">React island</span>
          <span class="text-slate-400">â†’</span>
          <span class="px-2 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-xs">Live stats</span>
        </div>
      </div>
    </div>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Tech Stack -->
    <h2 class="text-xl font-semibold flex items-center gap-2">âš¡ Tech Stack</h2>
    
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="border-b border-slate-200 dark:border-slate-700">
            <th class="text-left py-2 font-semibold">Layer</th>
            <th class="text-left py-2 font-semibold">Tech</th>
            <th class="text-left py-2 font-semibold">Why</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Framework</td>
            <td class="py-2">Astro 4.x</td>
            <td class="py-2 text-muted-foreground">Static-first, islands for interactivity</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Styling</td>
            <td class="py-2">Tailwind CSS</td>
            <td class="py-2 text-muted-foreground">Utility-first, dark mode support</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Islands</td>
            <td class="py-2">React 19</td>
            <td class="py-2 text-muted-foreground">Interactive components (stats, game)</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Analytics</td>
            <td class="py-2">PostHog</td>
            <td class="py-2 text-muted-foreground">Events, session replay, feature flags</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Database</td>
            <td class="py-2">Supabase (Postgres)</td>
            <td class="py-2 text-muted-foreground">Views, PostgREST API, edge functions</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Hosting</td>
            <td class="py-2">Cloudflare Pages</td>
            <td class="py-2 text-muted-foreground">Fast, free, global CDN</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Proxy</td>
            <td class="py-2">Cloudflare Worker</td>
            <td class="py-2 text-muted-foreground">PostHog reverse proxy (bypass blockers)</td>
          </tr>
          <tr class="border-b border-slate-100 dark:border-slate-800">
            <td class="py-2 font-medium">Monorepo</td>
            <td class="py-2">pnpm workspaces</td>
            <td class="py-2 text-muted-foreground">Shared components across packages</td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Analytics Flow -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸ“Š Analytics Pipeline</h2>
    
    <p class="text-muted-foreground">
      Real-time stats flow from user actions to the dashboard in ~5 seconds:
    </p>

    <ol class="space-y-3 mt-4">
      <li>
        <strong>User plays game</strong> â†’ PostHog SDK captures <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">ab_test_decision</code> event
      </li>
      <li>
        <strong>PostHog webhook</strong> â†’ Fires on event, sends JSON to Supabase Edge Function
      </li>
      <li>
        <strong>Edge Function</strong> â†’ Validates, transforms, inserts into <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">posthog_events</code> table
      </li>
      <li>
        <strong>Postgres View</strong> â†’ <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">ab_test_stats</code> aggregates totals, unique users, last 24h
      </li>
      <li>
        <strong>PostgREST</strong> â†’ Frontend fetches <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">/rest/v1/ab_test_stats</code>
      </li>
      <li>
        <strong>StatsCard</strong> â†’ React island renders live numbers with loading states
      </li>
    </ol>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Monorepo Structure -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸ“ Monorepo Structure</h2>
    
    <div class="text-sm space-y-4 mt-4">
      <!-- Root -->
      <div class="border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
        <div class="font-mono font-semibold text-foreground mb-3">soma-portfolio/</div>
        
        <div class="grid gap-4 sm:grid-cols-2">
          <!-- src -->
          <div class="space-y-2">
            <div class="font-mono text-xs text-slate-600 dark:text-slate-400">src/</div>
            <div class="pl-3 border-l-2 border-slate-200 dark:border-slate-700 space-y-1 text-xs text-muted-foreground">
              <div><span class="font-mono">pages/</span> â€” Routes (index, projects, contribute, stack, writing)</div>
              <div><span class="font-mono">content/post/</span> â€” MDX blog posts</div>
              <div><span class="font-mono">components/</span> â€” Site-specific components</div>
            </div>
          </div>
          
          <!-- packages -->
          <div class="space-y-2">
            <div class="font-mono text-xs text-slate-600 dark:text-slate-400">packages/</div>
            <div class="pl-3 border-l-2 border-slate-200 dark:border-slate-700 space-y-1 text-xs text-muted-foreground">
              <div><span class="font-mono">shared/</span> â€” ProjectCard, Timeline, Header, projects.yaml</div>
              <div><span class="font-mono">ab-simulator/</span> â€” Standalone game app</div>
            </div>
          </div>
          
          <!-- analytics -->
          <div class="space-y-2">
            <div class="font-mono text-xs text-slate-600 dark:text-slate-400">analytics/</div>
            <div class="pl-3 border-l-2 border-slate-200 dark:border-slate-700 space-y-1 text-xs text-muted-foreground">
              <div><span class="font-mono">notebooks/</span> â€” Jupyter analysis</div>
            </div>
          </div>
          
          <!-- config -->
          <div class="space-y-2">
            <div class="font-mono text-xs text-slate-600 dark:text-slate-400">config files</div>
            <div class="pl-3 border-l-2 border-slate-200 dark:border-slate-700 space-y-1 text-xs text-muted-foreground">
              <div><span class="font-mono">supabase-schema.sql</span></div>
              <div><span class="font-mono">cloudflare-posthog-proxy.js</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Key Files -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸ”— Key Files</h2>
    
    <ul class="space-y-2 list-none pl-0">
      <li>
        <a href="https://github.com/eeshansrivastava89/soma-portfolio/blob/main/supabase-schema.sql" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline">
          ğŸ“„ supabase-schema.sql â€” Database tables + views
        </a>
      </li>
      <li>
        <a href="https://github.com/eeshansrivastava89/soma-portfolio/blob/main/cloudflare-posthog-proxy.js" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline">
          ğŸ“„ cloudflare-posthog-proxy.js â€” Reverse proxy worker
        </a>
      </li>
      <li>
        <a href="https://github.com/eeshansrivastava89/soma-portfolio/blob/main/packages/shared/src/data/projects.yaml" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline">
          ğŸ“„ projects.yaml â€” Project metadata source of truth
        </a>
      </li>
      <li>
        <a href="https://github.com/eeshansrivastava89/soma-portfolio/tree/main/packages/ab-simulator/public/js" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline">
          ğŸ“ ab-simulator/public/js/ â€” Game logic modules
        </a>
      </li>
      <li>
        <a href="https://github.com/eeshansrivastava89/soma-portfolio" class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline">
          ğŸ“ Full repository
        </a>
      </li>
    </ul>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Adding a New Project -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸš€ Adding a New Project</h2>
    
    <p class="text-muted-foreground">
      Bootstrap a new project in 8 steps:
    </p>

    <ol class="space-y-2 mt-4">
      <li><strong>Add to projects.yaml</strong> â€” id, name, status, description, tags</li>
      <li><strong>Create package</strong> â€” <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">packages/&#123;project-name&#125;/</code> with Astro config</li>
      <li><strong>Add stats config</strong> â€” Supabase view name, display labels</li>
      <li><strong>Create Supabase view</strong> â€” Aggregate events for stats</li>
      <li><strong>Create hub page</strong> â€” <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">/projects/&#123;id&#125;.astro</code></li>
      <li><strong>Add aiStory</strong> â€” Bullets describing AI collaboration</li>
      <li><strong>Write blog post</strong> â€” With <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">projectId: &#123;id&#125;</code> frontmatter</li>
      <li><strong>Update Timeline</strong> â€” Move from coming-soon â†’ in-progress â†’ live</li>
    </ol>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- Writing Workflow -->
    <h2 class="text-xl font-semibold flex items-center gap-2">âœï¸ Writing Workflow</h2>
    
    <p class="text-muted-foreground">
      Blog posts live in <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">src/content/post/</code> as MDX files:
    </p>

    <div class="mt-4 border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-800/50">
      <div class="font-mono text-xs text-slate-600 dark:text-slate-400 mb-3">frontmatter example:</div>
      <div class="space-y-2 text-sm">
        <div class="flex gap-2">
          <span class="font-mono text-slate-500 dark:text-slate-400 w-24 shrink-0">title:</span>
          <span class="text-foreground">"How I Built the A/B Simulator"</span>
        </div>
        <div class="flex gap-2">
          <span class="font-mono text-slate-500 dark:text-slate-400 w-24 shrink-0">publishDate:</span>
          <span class="text-foreground">2025-11-30</span>
        </div>
        <div class="flex gap-2">
          <span class="font-mono text-slate-500 dark:text-slate-400 w-24 shrink-0">tags:</span>
          <span class="text-foreground">["data-science", "analytics"]</span>
        </div>
        <div class="flex gap-2">
          <span class="font-mono text-slate-500 dark:text-slate-400 w-24 shrink-0">projectId:</span>
          <span class="text-blue-600 dark:text-blue-400">"ab-simulator"</span>
          <span class="text-muted-foreground text-xs">â† links to hub</span>
        </div>
        <div class="flex gap-2">
          <span class="font-mono text-slate-500 dark:text-slate-400 w-24 shrink-0">featured:</span>
          <span class="text-emerald-600 dark:text-emerald-400">true</span>
          <span class="text-muted-foreground text-xs">â† shows on home</span>
        </div>
      </div>
    </div>

    <p class="text-sm text-muted-foreground mt-4">
      Posts with <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">projectId</code> appear in the project hub's "Related Content" section via <code class="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-sm">getPostsByProject()</code>.
    </p>

    <hr class="my-4 border-slate-200 dark:border-slate-700" />

    <!-- What's Next -->
    <h2 class="text-xl font-semibold flex items-center gap-2">ğŸ”® What's Next</h2>
    
    <!-- Timeline inside article with not-prose to reset prose styling -->
    <div class="not-prose mt-4">
      <Timeline 
        inProgressProjects={inProgressProjects} 
        upcomingProjects={upcomingProjects}
        title=""
      />
    </div>
    
  </article>

</BaseLayout>
