name: Run Notebooks

on:
  schedule:
    # Weekly on Sunday at 6am UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      notebook_filter:
        description: 'Filter notebooks by schedule (all/weekly/daily) or specific notebook id'
        required: false
        default: 'all'

env:
  PYTHON_VERSION: '3.11'

# Grant write permission to commit notebook outputs
permissions:
  contents: write

jobs:
  discover-notebooks:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Parse notebooks from projects.yaml
        id: set-matrix
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Extract notebooks with their project context
          NOTEBOOKS=$(yq -o=json '.projects[] | select(.notebooks != null) | {"projectId": .id, "notebooks": .notebooks}' packages/shared/src/data/projects.yaml | jq -s '
            [.[] | .projectId as $pid | .notebooks[] | {
              "id": .id,
              "projectId": $pid,
              "title": .title,
              "path": .path,
              "schedule": .schedule,
              "outputPath": .outputPath
            }]
          ')
          
          # Filter based on input (if provided)
          FILTER="${{ github.event.inputs.notebook_filter || 'all' }}"
          if [ "$FILTER" = "weekly" ]; then
            NOTEBOOKS=$(echo "$NOTEBOOKS" | jq '[.[] | select(.schedule == "weekly")]')
          elif [ "$FILTER" = "daily" ]; then
            NOTEBOOKS=$(echo "$NOTEBOOKS" | jq '[.[] | select(.schedule == "daily")]')
          elif [ "$FILTER" != "all" ]; then
            # Assume it's a specific notebook id
            NOTEBOOKS=$(echo "$NOTEBOOKS" | jq --arg id "$FILTER" '[.[] | select(.id == $id)]')
          fi
          
          echo "Found notebooks: $NOTEBOOKS"
          
          # Compact JSON and set output (escape for GH Actions)
          MATRIX=$(echo "{\"include\":$NOTEBOOKS}" | jq -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  run-notebook:
    needs: discover-notebooks
    if: ${{ needs.discover-notebooks.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover-notebooks.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r analytics/requirements.txt
      
      - name: Execute notebook
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          echo "Running: ${{ matrix.title }}"
          echo "Path: ${{ matrix.path }}"
          
          # Create output directory
          mkdir -p public/analysis/${{ matrix.outputPath }}
          
          # Execute notebook with papermill (captures fresh data)
          papermill "${{ matrix.path }}" "/tmp/${{ matrix.id }}-executed.ipynb" \
            --no-progress-bar \
            --log-output
          
          # Convert to HTML
          jupyter nbconvert "/tmp/${{ matrix.id }}-executed.ipynb" \
            --to html \
            --no-input \
            --output "${{ matrix.id }}" \
            --output-dir "public/analysis/${{ matrix.outputPath }}"
          
          echo "âœ“ Generated: public/analysis/${{ matrix.outputPath }}/${{ matrix.id }}.html"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: notebook-${{ matrix.id }}
          path: public/analysis/${{ matrix.outputPath }}/${{ matrix.id }}.html
          retention-days: 7

  commit-results:
    needs: run-notebook
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Move artifacts to public folder
        run: |
          # Create analysis directory
          mkdir -p public/analysis
          
          # Move each artifact to correct location
          for dir in artifacts/notebook-*/; do
            if [ -d "$dir" ]; then
              # Find HTML files and determine their destination from filename
              find "$dir" -name "*.html" -exec cp {} public/analysis/ \; 2>/dev/null || true
            fi
          done
          
          # Restructure based on projects.yaml outputPaths
          # For now, simple flat structure - can enhance later
          ls -la public/analysis/ || echo "No analysis files generated"
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add public/analysis/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: refresh notebook outputs [skip ci]
            
            Notebooks updated: $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
          fi
